<div id="leftContainer"><div>
	&nbsp;
</div></div>

<div id="rightContainer">
	<div>
		<div id="tabs"></div>
		<div id="rightContent"></div>
	</div>
</div>

<div id="middleContainer"><div>
	<div id="addFolderViewContainer"></div>
	<ul id="foldersContainer"></ul>
</div></div>

<script>
$(function() {
	new AddFolderView;	

	app.allTasks = new AllTasksCollection();
	app.allFolders = new AllFoldersCollection();

	app.folders = new FoldersCollection();
	app.folders.reset(<%= raw @result.to_json %>);

	new TabMenuView;
	new ChartsView;
	new ScheduleView;
	app.tabMenuView.selectScheduleTab();	

	$("ul.tasks").sortable({
		connectWith: "ul.tasks",
		placeholder: "dragging",
		handle: ".dragHorizIcon",
		axis: 'y',
		delay: 100,
		tolerance: 'pointer',
		receive: function(event, ui) {
			var pos = ui.item.parent('ul').children('li').index(ui.item);
			var model = app.allTasks.getByCid( ui.item.attr('cid') );
			var oldCollection = model.collection;

			var parentCid = ui.item.parent('ul').parent('li').attr('cid');
			if (ui.item.parent('ul').parent('li').parent('ul').attr('id') == 'foldersContainer') {
				var parentModel = app.folders.getByCid(parentCid);
				model.set({folder_id: parentModel.id, parentTaskId:null});
			} else {
				var parentModel = app.allTasks.getByCid(parentCid);
				model.set({folder_id: parentModel.get('folder_id'), parentTaskId: parentModel.id});
			}

			oldCollection.remove(model, {silent:true});
			parentModel.tasks.add(model, {at:pos, silent:true});
			parentModel.tasks.setOrderFromIndex();
			model.save();
		},

		update: function(event, ui) {
			// do all this shit so that update only runs when moving in same collection
			if (!ui.sender) {
				var pos = ui.item.parent('ul').children('li').index(ui.item);
				var model = app.allTasks.getByCid( ui.item.attr('cid') );
				if (model) {
					var oldCollection = model.collection
					var parentCid = ui.item.parent('ul').parent('li').attr('cid');
					if (ui.item.parent('ul').parent('li').parent('ul').attr('id') == 'foldersContainer') {
						var parentModel = app.folders.getByCid(parentCid);
					} else {
						var parentModel = app.allTasks.getByCid(parentCid);
					}
					if (parentModel.tasks == model.collection) {
						oldCollection.remove(model, {silent:true});
						oldCollection.add(model, {at:pos, silent:true});
						oldCollection.setOrderFromIndex();
						model.save();
					}
				}
			}
		},
	});

	$("ul#foldersContainer").sortable({
		placeholder: "dragging",
		handle: ".dragHorizIcon",
		axis: 'y',
		delay: 100,
		update: function(event, ui) {
			var pos = ui.item.parent('ul').children('li').index(ui.item);
			var model = app.folders.getByCid( ui.item.attr('cid') );
			app.folders.remove(model);
			app.folders.add(model, {at:pos});
		},
	});

});
</script>


<script id="addFolderViewTemplate" type="text/html">
	<table style="width:100%;">
		<tr>
			<td>
				<input type="text" placeholder="Add Project" id="addFolderInput">
			</td>
			<td style="text-align:right;width:1%;">
				&nbsp;<span class="btn" id="addProjectSubmitButton">Add Project</span>
				<span class="btn">Clear Completed</span>
			</td>
		</tr>
	</table>
</script>


<script id="containerViewTemplate" type="text/html">
	<div class="container"></div>
	<ul class="tasks"{{^openFolder}} style="display:none;"{{/openFolder}}></ul>
</script>


<script id="folderViewTemplate" type="text/html">
		<table style="width:100%">
			<tr>
				<td>
					<table style="width:100%;">
						<tr>
							<td style="vertical-align:top;width:25px;">
								<icon class="button {{#openFolder}}openFolderIcon{{/openFolder}}{{^openFolder}}closedFolderIcon{{/openFolder}}"></icon>
							</td>
							<td>
								<div class="nameField">{{displayName}}</div>
								<div class="nameFieldEdit" style="display:none;"><textarea style="width:100%;" rows="1">{{name}}</textarea><div>
							</td>
						</tr>
					</table>
				</td>
				<td style="text-align:right;vertical-align:top;width:1%;white-space:nowrap;">
					<span class="displayStartDateFromNow">{{displayStartDateFromNow}}</span>
					<icon class="plusIcon button"></icon>
					<icon class="trashIcon button"></icon>
					<icon class="dragHorizIcon button"></icon>
				</td>
			</tr>
		</table>
</script>


<script id="taskViewTemplate" type="text/html">
	<table style="width:100%">
			<tr>
				<td>
					<table style="width:100%;">
						<tr>
							<td style="vertical-align:top;width:25px;">
								<input type="checkbox"{{#checked}} checked{{/checked}}>
							</td>
							<td>
								<div class="nameField">{{displayName}}</div>
								<div class="nameFieldEdit" style="display:none;"><textarea style="width:100%;" rows="1">{{name}}</textarea><div>
							</td>
						</tr>
					</table>
				</td>
				<td style="text-align:right;vertical-align:top;width:40px;white-space:nowrap;">
					<span class="displayStartDateFromNow">{{displayStartDateFromNow}}</span>
					<icon class="plusIcon button"></icon>
					<icon class="trashIcon button"></icon>
					<icon class="dragHorizIcon button"></icon>
				</td>
			</tr>
		</table>
</script>


<script id="tabMenuViewTemplate" type="text/html">
	<ul>
		<li id="scheduleTab">Schedule</li>
		<li id="chartsTab">Charts</li>
		<li id="taskTab" style="display:none;">Task</li>
	</ul>
</script>


<script id="taskEditViewTemplate" type="text/html">
	<table style="height:100%;width:100%;">
		<tr><td>
			<textarea style="width:100%;height:100%;" placeholder="Notes">{{notes}}</textarea>
		</td></tr>
		<tr style="height:1%;"><td>
			{{#tempShowStartDate}}
				<div>Due Date: {{tempPrettyStartDate}} {{tempStartDateFromNow}}</div>
			{{/tempShowStartDate}}
			Task created {{tempCreatedDateFromNow}}
		</td></tr>
	</table>
</script>


<script id="chartsViewTemplate" type="text/html">
	<div>chartsView</div>
</script>


<script id="scheduleViewTemplate" type="text/html">

	<table>
			<% (0..30).each do |i| %>
		      <% 
		      date_id = (Time.zone.today + i.days).to_s() 
		      date_str = i == 0 ? 'Today' : (Time.zone.today + i.days).to_s(:chart) 
		      weekend = ['Sat', 'Sun']
		      %>
		      <tr class="<%= cycle("schedule_even", "schedule_odd") %><%= " weekend" if weekend.include?((Time.zone.today+i.days).strftime("%a")) %>">
		        <td class="schedule_date"><%= date_str %></td>
		        <td class="schedule_date_container" id="<%= "schedule_#{date_id}" %>"></td>
		      </tr>
		    <% end %>
		</table>
</script>


<script id="outlineRowViewTemplate" type="text/html">
	<div>{{displayName}}</div>
</script>


<script id="scheduleRowViewTemplate" type="text/html">
	<div>{{displayName}}</div>
</script>